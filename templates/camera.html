<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Camera Capture</title>
<style>
    :root {
        --bg-color: #1a1b26;
        --panel-bg: #24283b;
        --text-color: #c0caf5;
        --header-color: #a9b1d6;
        --border-color: #414868;
        --accent-green: #9ece6a;
        --accent-red: #f7768e;
        --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --font-mono: "Fira Code", "Consolas", "Courier New", monospace;
    }

    body {
        font-family: var(--font-main);
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h1 {
        color: var(--header-color);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    button {
        background-color: var(--accent-green);
        color: white;
        font-size: 16px;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease-in-out;
        margin-bottom: 1.5rem;
    }

    button:hover {
        background-color: #a6d87a;
    }

    img {
        max-width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }

    #pixelInfo {
        margin-top: 10px;
        font-family: var(--font-mono);
        font-size: 14px;
        color: var(--text-color);
        background-color: var(--panel-bg);
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        display: inline-block;
        min-width: 180px;
        text-align: center;
        user-select: none;
    }

    #magnifierBox {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 150px;
        height: 150px;
        border: 2px solid var(--border-color);
        overflow: hidden;
        border-radius: 12px;
        background-color: var(--panel-bg);
        display: none;
        z-index: 10;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
    }

    #magnifierCanvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    a {
        margin-top: 2rem;
        color: var(--text-color);
        text-decoration: none;
        font-weight: 500;
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }

    a:hover {
        background-color: var(--panel-bg);
    }
    #backBtn {
        position: fixed;
        top: 16px;
        left: 16px;
        background-color: var(--panel-bg);
        color: var(--text-color);
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        text-decoration: none;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        z-index: 1000;
        user-select: none;
    }

    #backBtn:hover {
        background-color: var(--accent-blue, #7aa2f7);
        color: white;
        box-shadow: 0 6px 14px rgba(122, 162, 247, 0.7);
    }
</style>
</head>
<body>

<h1>âœ¨ Capture Camera Frame âœ¨</h1>

<button onclick="captureFrame()">ðŸ“· Capture Frame</button>
<label style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    <input type="checkbox" id="runModelCheckbox" checked />
    <span>Overlay model predictions</span>
</label>

<canvas id="canvas" style="display: none;"></canvas>

<img
    id="capturedImage"
    src=""
    alt="Captured frame will appear here."
    onmousemove="showPixelInfo(event)"
    onmouseleave="hideMagnifier()"
    draggable="false"
/>

<div id="pixelInfo">Hover over the image to see pixel coordinates</div>

<div id="magnifierBox">
    <canvas id="magnifierCanvas" width="150" height="150"></canvas>
</div>

<a href="/" id="backBtn">â¬… Back to Main</a>

<script>
    const canvas = document.getElementById('canvas');
    const magnifierCanvas = document.getElementById('magnifierCanvas');
    const magnifierBox = document.getElementById('magnifierBox');
    const magCtx = magnifierCanvas.getContext('2d');

    function captureFrame() {
        const runModel = document.getElementById('runModelCheckbox').checked;
        fetch(`/capture_frame?run_model=${runModel}`)
            .then(response => response.blob())
            .then(blob => {
                const imgURL = URL.createObjectURL(blob);
                const img = document.getElementById('capturedImage');
                img.onload = () => {
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = imgURL;
            })
            .catch(error => {
                alert("Failed to capture frame: " + error);
            });
    }

    function showPixelInfo(event) {
        const img = document.getElementById('capturedImage');
        const infoBox = document.getElementById('pixelInfo');

        if (!img.complete || img.naturalWidth === 0) return;

        const rect = img.getBoundingClientRect();
        const scaleX = img.naturalWidth / rect.width;
        const scaleY = img.naturalHeight / rect.height;

        const x = Math.floor((event.clientX - rect.left) * scaleX);
        const y = Math.floor((event.clientY - rect.top) * scaleY);

        if (x >= 0 && y >= 0 && x < img.naturalWidth && y < img.naturalHeight) {
            infoBox.textContent = `Pixel: (x: ${x}, y: ${y})`;

            // Magnifier logic
            const ctx = canvas.getContext('2d');
            const zoom = 4;
            const size = 20;

            const imgData = ctx.getImageData(
                Math.max(0, x - size / 2),
                Math.max(0, y - size / 2),
                size,
                size
            );

            magCtx.clearRect(0, 0, magnifierCanvas.width, magnifierCanvas.height);
            magCtx.imageSmoothingEnabled = false;
            magCtx.putImageData(imgData, 0, 0);
            magCtx.drawImage(magnifierCanvas, 0, 0, size, size, 0, 0, 150, 150);

            // Draw crosshair
            magCtx.strokeStyle = 'red';
            magCtx.lineWidth = 1;
            magCtx.beginPath();
            magCtx.moveTo(75, 0);
            magCtx.lineTo(75, 150);
            magCtx.moveTo(0, 75);
            magCtx.lineTo(150, 75);
            magCtx.stroke();

            magnifierBox.style.display = 'block';
        } else {
            hideMagnifier();
        }
    }

    function hideMagnifier() {
        magnifierBox.style.display = 'none';
    }
</script>

<footer style="margin-top: 4rem; text-align: center; font-size: 14px; color: var(--text-color); opacity: 0.5;">
    &copy; 2025 Advanced Power System Labs. All rights reserved.
</footer>
</body>
</html>
