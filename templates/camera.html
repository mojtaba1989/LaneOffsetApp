<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Camera Capture</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        button:hover {
            background-color: #45a049;
        }

        img {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #pixelInfo {
            margin-top: 10px;
            font-size: 14px;
            color: #444;
            background: #eee;
            padding: 6px 10px;
            display: inline-block;
            border-radius: 4px;
        }

        #magnifierBox {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            border: 2px solid #333;
            overflow: hidden;
            border-radius: 8px;
            display: none;
            z-index: 10;
        }

        #magnifierCanvas {
            width: 100%;
            height: 100%;
        }

        a {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: #333;
        }
    </style>
</head>
<body>

<h1>Capture Camera Frame</h1>
<button onclick="captureFrame()">ðŸ“· Capture Frame</button><br>

<canvas id="canvas" style="display: none;"></canvas>
<img id="capturedImage" src="" alt="Captured frame will appear here." onmousemove="showPixelInfo(event)" onmouseleave="hideMagnifier()">
<div id="pixelInfo">Hover over the image to see pixel coordinates</div>
<div id="magnifierBox">
    <canvas id="magnifierCanvas" width="150" height="150"></canvas>
</div>

<br><a href="/">â¬… Back to Main</a>

<script>
    const canvas = document.getElementById('canvas');
    const magnifierCanvas = document.getElementById('magnifierCanvas');
    const magnifierBox = document.getElementById('magnifierBox');
    const magCtx = magnifierCanvas.getContext('2d');

    function captureFrame() {
        fetch('/capture_frame')
            .then(response => response.blob())
            .then(blob => {
                const imgURL = URL.createObjectURL(blob);
                const img = document.getElementById('capturedImage');
                img.onload = () => {
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = imgURL;
            })
            .catch(error => {
                alert("Failed to capture frame: " + error);
            });
    }

    function showPixelInfo(event) {
        const img = document.getElementById('capturedImage');
        const infoBox = document.getElementById('pixelInfo');

        if (!img.complete || img.naturalWidth === 0) return;

        const rect = img.getBoundingClientRect();
        const scaleX = img.naturalWidth / rect.width;
        const scaleY = img.naturalHeight / rect.height;

        const x = Math.floor((event.clientX - rect.left) * scaleX);
        const y = Math.floor((event.clientY - rect.top) * scaleY);

        if (x >= 0 && y >= 0 && x < img.naturalWidth && y < img.naturalHeight) {
            infoBox.textContent = `Pixel: (x: ${x}, y: ${y})`;

            // Magnifier logic
            const ctx = canvas.getContext('2d');
            const zoom = 4;
            const size = 20;

            const imgData = ctx.getImageData(
                Math.max(0, x - size / 2),
                Math.max(0, y - size / 2),
                size,
                size
            );

            magCtx.clearRect(0, 0, magnifierCanvas.width, magnifierCanvas.height);
            magCtx.imageSmoothingEnabled = false;
            magCtx.putImageData(imgData, 0, 0);
            magCtx.drawImage(magnifierCanvas, 0, 0, size, size, 0, 0, 150, 150);

            // Draw crosshair
            magCtx.strokeStyle = 'red';
            magCtx.lineWidth = 1;
            magCtx.beginPath();
            magCtx.moveTo(75, 0);
            magCtx.lineTo(75, 150);
            magCtx.moveTo(0, 75);
            magCtx.lineTo(150, 75);
            magCtx.stroke();

            magnifierBox.style.display = 'block';
        } else {
            hideMagnifier();
        }
    }

    function hideMagnifier() {
        magnifierBox.style.display = 'none';
    }
</script>

</body>
</html>
